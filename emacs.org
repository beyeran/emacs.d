#+TITLE: emacs.org
#+AUTHOR: Andre Pascal Beyer
#+DATE: 2013-12-20

* Globals, Functions and Settings
** Globals
#+begin_src emacs-lisp :tangle emacs.el
(require 'eldoc)

(prefer-coding-system 'utf-8)

(setq user-mail-address "beyeran@gmail.com")
(setq-default indent-tabs-mode nil)
(setq-default tab-width 4)
(setq inhibit-startup-echo-area-message t)
(setq inhibit-startup-message t)

(defun add-to-load-path (path)
  "Wrapps the ADD-TO-LIST function for the LOAD-PATH variable"
  (add-to-list 'load-path path))

(defun add-theme (path)
  "Wrapps the ADD-TO-LIST function for the CUSTOM-THEME-LOAD-PATH variable"
  (add-to-list 'custom-theme-load-path (format "~/.emacs.d/color-theme/%s"
					       path)))

(defun add-to-alist (suffix-mode-list)
  "Wrapps the ADD-TO-LIST function for the AUTO-MODE-ALIST variable"
  (add-to-list 'auto-mode-alist suffix-mode-list))

(mapc #'load (directory-files "~/.emacs.d/src/" t "\\.el$"))

(add-to-load-path "~/.emacs.d/src/")
#+end_src
** Macros
#+begin_src emacs-lisp :tangle src/functions.el
(defmacro with-module (symbol name-string &rest body)
  `(condition-case nil
       (progn
         (add-to-load-path  ,(format "%s%s" *modules-dir* name-string))
         (autoload ',symbol ,name-string ,name-string t)
         ,@body)
     
     (error (message (format " => problem loading %s" ',symbol))
            nil)))

(defmacro with-library (symbol &rest body)
  `(condition-case nil
       (progn
         (add-to-load-path ,(format "%s%s" *modules-dir* symbol))
         (require ',symbol)
         ,@body)))
#+end_src
** Settings
#+begin_src emacs-lisp :tangle src/settings.el
(put 'with-module 'lisp-indent-function 1)

(defun pretty-lambdas ()
  (font-lock-add-keywords
   nil `(("(\\(lambda\\>\\)"
          (0 (progn (compose-region (match-beginning 1) (match-end 1)
                                    ,(make-char 'greek-iso8859-7 107))
                    nil))))))

(font-lock-add-keywords 'emacs-lisp-mode
                        '(("(\\(lambda\\)\\>" (0 (prog1 ()
                                              (compose-region (match-beginning 1)
                                                              (match-end 1)
                                                              λ))))))

(font-lock-add-keywords 'python
                        '(("lambda" (0 (prog1 ()
                                         (compose-region (match-beginning 1)
                                                         (match-end 1)
                                                         λ))))))
#+end_src
* Modes
** darcs
#+begin_src emacs-lisp :tangle src/modules.el
;;
;; darcsum
;;

(with-library darcsum)
#+end_src
** magit
#+begin_src emacs-lisp :tangle src/modules.el
;;
;; magit
;;

;; (eval-after-load 'info
;;  '(progn (info-initialize)
;;          (add-to-list 'Info-directory-list "~/.emacs.d/modules/magit/")))

;; (with-library git-commit-mode)
;; (with-library magit)

#+end_src
** paredit
#+begin_src emacs-lisp :tangle src/modules.el
;;
;; paredit
;;
(defun add-paredit (mode)
  "Wrapps the function used for adding paredit to mode hooks"
  (add-hook mode #'enable-paredit-mode))

(with-module enable-paredit-mode "paredit"
             (add-paredit 'emacs-lisp-mode)
             (add-paredit 'eval-expression-minibuffer-setup-hook)
             (add-paredit 'ielm-mode-hook)
             (add-paredit 'lisp-mode-hook)
             (add-paredit 'lisp-interaction-mode-hook)
             (add-paredit 'scheme-mode-hook)
             (add-paredit 'python-mode-hook))

(eldoc-add-command
 'paredit-backward-delete
 'paredit-close-round)

#+end_src
** xml-parse
#+begin_src emacs-lisp :tangle src/modules
;;
;; xml-parse
;;

;; (with-library xml-parse)

#+end_src
** ruby
#+begin_src emacs-lisp :tangle src/modules
;;
;; inf-ruby
;;

(with-library inf-ruby
              (define-key ruby-mode-map (kbd "C-c C-c") 'ruby-send-definition)
              (define-key ruby-mode-map (kbd "C-c C-r") 'ruby-send-region)
              (define-key ruby-mode-map (kbd "C-c C-b") 'ruby-send-buffer))
#+end_src
** powerline
#+begin_src emacs-lisp :tangle src/modules.el
;;
;; powerline
;;
;; (with-library powerline
;;              (powerline-center-theme))

#+end_src
** languages
*** perl
#+begin_src emacs-lisp :tangle src/modules.el
;;
;; perl
;;

;; (with-library sepia
;;               (setq sepia-perl5lib (list (expand-file-name "~/.emacs.d/modules/sepia/lib")))
;;               (defalias 'perl-mode 'sepia-mode))

#+end_src
*** chicken
#+begin_src emacs-lisp :tangle src/modules.el
(require 'autoinsert)
(add-hook 'find-file-hooks 'auto-insert)

(setq auto-insert-alist
      '(("\\.scm" .
         (insert "#!/usr/bin/csi -s\n\n"))))

(setf scheme-program-name "csi")
#+end_src
*** haskell
#+begin_src emacs-lisp :tangle src/modules.el
;;
;; haskell mode
;;
(with-library haskell-mode
              (require 'haskell-mode-autoloads)
              (add-to-list 'Info-default-directory-list "~/.emacs.d/modules/haskell-mode/")

              (add-to-alist '("\\.\\(hs\\|lhs\\)$" . haskell-mode))

              (add-hook 'haskell-mode-hook 'turn-on-haskell-indent))


#+end_src
*** lisp
#+begin_src emacs-lisp :tangle src/modules.el
;;
;; lisp
;;
(setq inferior-lisp-program (case system-type
                                  ((windows-nt cygwin) "c:/ccl/wx86cl -K utf-8")))

#+end_src
*** clojure
#+begin_src emacs-lisp :tangle src/modules.el
;;
;; clojure
;;

(with-library clojure-mode
              (add-to-alist '("\\.\\(clj\\)$" . clojure-mode)))

;;
;; needed for cider
;;
(with-library epl)
(with-library dash)
(with-library pkg-info)

(with-library cider
              (add-hook 'cider-mode-hook 'cider-turn-on-eldoc-mode)
              (setq nrepl-hide-special-buffers t)
              (setq cider-repl-pop-to-buffer-on-connect nil)
              (setq cider-repl-results-prefix ";; => "))

#+end_src
*** julia
#+begin_src emacs-lisp :tangle src/modules.el
;;
;; julia
;;

(with-library julia-mode)

#+end_src

*** APL
#+begin_src emacs-lisp :tangle src/modules.el
;;
;; APL
;;

(add-to-list 'load-path "~/.emacs.d/modules/apl")

(when (require 'gnu-apl-mode nil t)
  (dolist (hook '(gnu-apl-mode-hook gnu-apl-interactive-mode-hook))
    (add-hook hook (lambda ()
                     (eldoc-mode)
                     (setq buffer-face-mode-face 'gnu-apl-default)
                     (buffer-face-mode))))
  (set-face-attribute 'gnu-apl-default nil
                      :family "DejaVu Sans Mono")
  (add-to-list 'auto-mode-alist '("\\.apl$" . gnu-apl-mode)))

(setq gnu-apl-show-keymap-on-startup t)

(add-hook 'gnu-apl-interactive-mode-hook 
          '(lambda ()
             (setq buffer-face-mode 'gnu-apl-default)
             (buffer-face-mode)))

#+end_src
** jedi
#+begin_src emacs-lisp :tangle src/modules.el
;;
;; jedi
;;

(with-library popup)
(with-library auto-complete)
(with-library ctable)
(with-library deferred)
(with-library epc)

(with-library jedi
              (add-hook 'python-mode-hook 'jedi:setup)
              (setq jedi:setup-keys t)
              (setq jedi:complet-on-dot t))
#+end_src

** iBuffer
#+begin_src emacs-lisp :tangle src/modules.el
;;;;
;;;; ibuffer
;;;;

(require 'ibuffer nil t)

(setq ibuffer-show-empty-filter-groups nil
      ibuffer-expert t)

(setq ibuffer-saved-filter-groups
      '(("default"
         ("elisp" (or (name . "\\.el$")
                      (mode . emacs-lisp-mode)))
         ("cl" (or (name . "\\.lisp$")
                   (name . "\\.asdf$")
                   (mode . lisp-mode)
                   (mode . slime-mode)))
         ("scheme" (or (name . "\\.scm$")
                       (mode . scheme-mode)
                       (mode . geiser-mode)))
         ("clojure" (or (name . "\\.clj$")
                        (mode . clojure-mode)))
         ("python" (or (name . "\\.py$")
                       (mode . python-mode)
                       (mode . python-2-mode)
                       (mode . python-3-mode)))
         ("ruby" (or (name . "\\.rb$")))
         ("perl" (mode . cperl-mode))
         ("shell" (or (name . "\\.sh$")
                      (name . "^\\.zshrc$")
                      (name . "^\\.profile")
                      (mode . shell-script-mode)))
         ("R" (name . "\\.R$"))
         ("julia" (name . "\\.jl$"))
         ("haskell" (or (name . "\\.hs$")
                        (mode . haskell-mode)))
         ("C" (or (name . "\\.c$")
                  (name . "\\.h$")
                  (mode . c-mode)))
         ("C++" (or (name . "\\.cpp$")
                    (name . "\\.hpp$")
                    (mode . c++-mode)))
         ("java" (or (name . "\\.java$")
                     (mode . java-mode)))
         ("css" (or (name . "\\.css$")
                    (mode . css-mode)))
         ("javascript" (or (name . "\\.js$")
                           (name . "\\.json$")
                           (mode . javascript-mode)
                           (mode . js2-mode)))
         ("tex" (or (name . "\\.tex$")
                    (mode . tex-mode)))
         ("org" (or (name . "\\.org$")
                    (mode . org-mode)))
         ("text" (or (name . "\\.txt$")
                     (mode . text-mode)))
         ("dired" (mode . dired-mode)))))

(add-hook 'ibuffer-mode-hook
          (lambda ()
            (ibuffer-switch-to-saved-filter-groups "default")
            (ibuffer-auto-mode 1)))

#+end_src
* Org
** Org Settings for Capture
   The capture and refill functionality is handled here.
*** General Settings
#+begin_src emacs-lisp :tangle src/myorg.el
  (add-to-list 'auto-mode-alist '("\\.\\(org\\|org_archive\\)$" . org-mode))

  ;; some keys
  (global-set-key "\C-cl" 'org-store-link)
  (global-set-key "\C-ca" 'org-agenda)
  (global-set-key "\C-cb" 'org-iswitchb)

  ;; hide stars:
  (setq org-hide-leading-stars 'hidestars)

  ;; "Enter" key follows links
  (setq org-return-follows-link t)

  ;; Capture with "C-c c"
  (define-key global-map "\C-cc" 'org-capture)

  ;; different paths per OS must be set (to be done)
  (defvar org-dropbox-path "~/Dropbox/org/")

  ;; diverse general settings
  (setq org-src-fontify-natively t)
  (setq org-src-tab-acts-natively t)
#+end_src
*** Babel
#+begin_src emacs-lisp :tangle src/myorg.el
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((emacs-lisp . t)
     (sh . t)
     (R . t)
     (perl . t)
     (octave . t)
     (ruby . t)
     (python . t)
     (js . t)
     (lisp . t)
     (haskell . t)))

  ;; speaciality for R
  (add-to-list 'org-src-lang-modes
               '("r" . ess-mode))

  ;; nice bullets
  (with-library org-bullets
                (add-hook 'org-mode-hook (lambda () (org-bullets-mode 1))))
#+end_src
*** Templates & Refill
#+begin_src emacs-lisp :tangle src/myorg.el
  (setq org-capture-templates
        '(("n" "notes" entry (file+headline (concat org-dropbox-path "notes.org")
                                            "Notes"
                                            "* %?\Entered on %U\n  %i"))
          ("t" "tasks" entry (file+headline (concat org-dropbox-path "tasks.org")
                                            "Tasks"
                                            "* TODO %?\Entered on %U\n  %i"))
          ("c" "calendar" entry (file+headline (concat org-dropbox-path "calendar.org")
                                               "Calendar"
                                               "* %?\Entered on %U\n  %i"))
          ("o" "obligation" entry (file+headline (concat org-dropbox-path "obligations.org")
                                                 "Obligation"
                                                 "* TODO %?\Entered on %U\n  %i"))))

  ;;;; Refilling task
  ;; Use IDO
  (setq org-completion-use-ido t)

  ;; Targets start with the file name - allows creating level 1 tasks
  (setq org-refile-use-outline-path (quote file))

  ;; Targets complete in steps so we start with filename, TAB shows the nest level of targets etc.
  (setq org-outline-path-complete-in-steps t)

  ;; Keywords & drawers
  (setq org-todo-keywords
        '((sequence "TODO(t)" "STARTED(s)" "WAITING(w)" "DELEGATED(g)" "|"
                    "DONE(d)" "CANCELED(c)")))

  ;; colors
  (setq org-todo-keyword-faces
        '(("TODO"      . (:foreground "red"         :weight bold))
          ("STARTED"   . (:foreground "green"       :weight bold))
          ("WAITING"   . (:foreground "sienna"      :weight bold))
          ("DELEGATED" . (:foreground "forestgreen" :weight bold))
          ("DONE"      . (:foreground "forestgreen" :weight bold))
          ("CANCELED"  . shadow)))

  ;; Fast TODO Selection
  (setq org-use-fast-todo-selection t)

  ;; Logging - important
  (setq org-log-done 'time)
  (setq org-log-into-drawer t)
#+end_src
*** Agenda
#+begin_src emacs-lisp :tangle src/myorg.el
  ;;;; Agenda
  ;; highlight active line
  (add-hook 'org-agenda-mode-hook '(lambda () (hl-line-mode 1)))

  (setq org-agenda-format-date "%Y-%m-%d")

  ;; color for different priorities
  (setq org-agenda-fontify-priorities
        '((65 (:foreground "Red"))
          (66 (:foreground "Blue"))
          (67 (:foreground "Darkgreen"))))

  (setq org-agenda-date-weekend '(:foreground "Yellow" :weight bold))

  ;; Hide done or past tasks
  (setq org-agenda-skip-deadline-if-done t)
  (setq org-agenda-skip-scheduled-if-done t)

  ;; agenda view
  (setq org-agenda-custom-commands
        '(("s" "SOMEDAY" tags "someday"
           ((org-agenda-filter-present
             '("+someday"))
            (org-agenda-todo-ignore-with-date nil)))))

  ;; agenda files
  (setq org-agenda-files (mapcar '(lambda (n) (concat org-dropbox-path n))
                                 '("notes.org" "tasks.org" "calendar.org" "obligations.org")))
#+end_src
* Eyecandy
#+begin_src emacs-lisp :tangle "src/eyecandy.el"
;;
;; color theme
;;

;; (add-theme "sunburst")
;; (load-theme 'sunburst t)
;; (add-theme "monokai")
;; (load-theme 'monokai t)
;; (add-to-list 'load-path  "~/.emacs.d/color-theme/tomorrow")
;; (require 'color-theme-sanityinc-tomorrow)
;; (color-theme-sanityinc-tomorrow-bright)
(add-to-list 'custom-theme-load-path "~/.emacs.d/modules/color-themes/themes")
(load-theme 'graham t)

;;
;; hud
;;
(menu-bar-mode 0)
(tool-bar-mode 0)
(scroll-bar-mode 0)
(global-visual-line-mode 1)
(show-paren-mode 1)
(global-hl-line-mode 1)
(setq inhibit-splash-screen t)
(setq visible-bell t)

;;
;; font
;;
(set-face-attribute 'default nil :font "Source Code Pro-8")
;; (set-default-font "Droid Sans Mono-9")
#+end_src
